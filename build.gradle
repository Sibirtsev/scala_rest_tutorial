// используем язык Scala
apply plugin: 'scala'

ext.scala_version = '2.9.1'
ext.jersey_version = '1.12'
ext.description = 'Accessing various calculation tasks'
ext.classes_directory = new File('classes')

// вспомогательная функция удаления папки — аналог «rm -rf»
def delete_folder(File folder)
{
	if (folder.isDirectory())
	{
		String[] children = folder.list()
		int i = 0
		while (i < children.length)
		{
			boolean success = delete_folder(new File(folder, children[i]))
			if (!success)
			{
				return false
			}
			i++
		}
	}
	
	// The directory is now empty so delete it
	return folder.delete()
}

// эта задача очищает папку «classes» — можете запустить вручную, если будет нужно
task clean_output_folders <<
{
	delete_folder(classes_directory)
	classes_directory.mkdirs()
}

// основная задача — запускает наш веб-сервис
// сначала запускает «compileJava» и «compileScalaScala», а потом уже выполняется сама
task go(dependsOn: ['compileJava', 'compileScalaScala'], type: JavaExec) {
	main = 'Main'
	classpath = sourceSets.main.runtimeClasspath
	standardInput = System.in
	//args 'arguments`'
	systemProperty 'port', '8090'
}

// наборы исходных кодов
sourceSets
{
	// главный - Ява
	main
	{
		java
		{
			// исходники искать в папке «sources»
			srcDir 'sources'
		}
	}
	// ещё один - Scala
	scala
	{
		scala
		{
			// исходники искать в папке «sources»
			srcDir 'sources'
		}
	}
}

// скомпилированные Ява-классы класть в папку «classes»
sourceSets.main.output.classesDir = 'classes'
		
// скомпилированные Scala-классы класть в папку «classes»
sourceSets.scala.output.classesDir = 'classes'

// используемые библиотеки
dependencies
{
	// служебные библиотеки для обработки Scala из Gradle
	scalaTools group: 'org.scala-lang', name: 'scala-compiler', version: scala_version
	scalaTools group: 'org.scala-lang', name: 'scala-library', version: scala_version
	
	// сама Scala, нужна для компиляции кода на Scala
	compile group: 'org.scala-lang', name: 'scala-library', version: scala_version
	scalaCompile group: 'org.scala-lang', name: 'scala-library', version: scala_version
	
	// прочие библиотеки, используемые в программе
	
	scalaCompile group: 'asm', name: 'asm', version: '3.3.1'
	scalaCompile group: 'javax.ws.rs', name: 'jsr311-api', version: '1.1.1'
	scalaCompile group: 'com.sun.jersey', name: 'jersey-bundle', version: jersey_version
	scalaCompile group: 'com.sun.jersey', name: 'jersey-client', version: jersey_version
	scalaCompile group: 'com.sun.jersey', name: 'jersey-core', version: jersey_version
	scalaCompile group: 'com.sun.jersey', name: 'jersey-server', version: jersey_version
	scalaCompile group: 'com.sun.jersey', name: 'jersey-grizzly2', version: jersey_version
	scalaCompile group: 'com.sun.jersey', name: 'jersey-bundle', version: jersey_version

	runtime group: 'asm', name: 'asm', version: '3.3.1'
	runtime group: 'javax.ws.rs', name: 'jsr311-api', version: '1.1.1'
	runtime group: 'com.sun.jersey', name: 'jersey-bundle', version: jersey_version
	runtime group: 'com.sun.jersey', name: 'jersey-client', version: jersey_version
	runtime group: 'com.sun.jersey', name: 'jersey-core', version: jersey_version
	runtime group: 'com.sun.jersey', name: 'jersey-server', version: jersey_version
	runtime group: 'com.sun.jersey', name: 'jersey-bundle', version: jersey_version
	runtime group: 'com.sun.jersey', name: 'jersey-grizzly2', version: jersey_version
	
	// до кучи можно просто класть jar-ники в папку «libraries», 
	// и они тоже подхватятся в качестве библиотек
	
	scalaCompile fileTree(dir: 'libraries', include: '*.jar')
	scalaCompile files('classes')
	
	runtime fileTree(dir: 'libraries', include: '*.jar')
	runtime files('classes')
}

// компилирует код на Scala
compileScala
{
	// какой-то «демон» для Scala — убыстряет компиляцию
	scalaCompileOptions.useCompileDaemon = true
	// куда
	destinationDir = file('classes')
	// откуда
	source = file('sources')
}

// откуда качать используемые библиотеки
repositories
{
    mavenCentral()
}